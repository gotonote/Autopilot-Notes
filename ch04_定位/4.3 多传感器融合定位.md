# 4.3 多传感器融合定位

## 一、为什么需要多传感器融合

### 1. 单一传感器的局限性

自动驾驶系统需要连续、可靠、高精度的定位信息。然而，任何单一传感器都无法在所有场景下满足这些要求：

<!-- 插入一行空格 -->
<div align=center>
<img src="../imgs/sensor_limitations.png" width="650" height="380">
</div>
<div align=center>图1. 各传感器在不同场景下的性能表现</div>
<!-- 插入一行空格 -->

#### 1.1 GNSS的局限

**优势**：
- 提供绝对位置参考
- 长期精度稳定（无漂移）
- 全球覆盖

**局限**：
- **信号遮挡**：高楼、隧道、地下车库无信号
- **多路径效应**：城市峡谷中的信号反射导致误差
- **更新频率低**：通常$1-10Hz$，无法满足高速场景需求
- **定位抖动**：民用GPS精度约$5-10m$，无法满足自动驾驶需求（即使使用RTK也需要持续信号）

#### 1.2 IMU的局限

**优势**：
- 高频输出（$100-1000Hz$）
- 短时间精度高
- 不受环境影响

**局限**：
- **累积误差**：积分运算导致误差随时间发散
- **零偏漂移**：陀螺仪和加速度计存在零偏，积分后误差平方增长

误差传播模型：

$$\sigma_{\text{position}}(t) = \sigma_{\text{bias}} \cdot \frac{t^2}{2}$$

仅依赖IMU，几秒钟内定位误差可达数十米。

#### 1.3 视觉/激光里程计的局限

**优势**：
- 相对定位精度高
- 输出频率高
- 可构建环境地图

**局限**：
- **尺度不确定性**（单目视觉）
- **动态物体干扰**：运动物体会破坏静态环境假设
- **特征退化**：走廊、隧道等场景缺乏特征
- **累积漂移**：长距离运行后误差累积

#### 1.4 高精地图匹配的局限

**优势**：
- 可实现厘米级定位
- 全局一致性

**局限**：
- **依赖先验地图**：地图未覆盖区域无法工作
- **环境变化敏感**：施工、季节变化会影响匹配
- **计算资源要求高**：大规模点云匹配计算量大

### 2. 融合的必要性

多传感器融合可以：

**（1）互补优势**
- GNSS提供绝对位置，校正IMU漂移
- IMU提供高频姿态，填补GNSS间隙
- 视觉/激光提供相对运动，增强鲁棒性
- 地图匹配提供高精度全局定位

**（2）提高鲁棒性**
- 单一传感器失效时，系统仍可工作
- 通过冗余设计提高安全性

**（3）满足自动驾驶需求**
| 需求 | 单一传感器 | 融合系统 |
|------|-----------|----------|
| **精度** | $<10m$（GNSS）或漂移（IMU） | $<10cm$ |
| **频率** | $10Hz$（GNSS）或$100Hz$（IMU） | $100Hz+$ |
| **可用性** | 受环境影响 | 全天候、全场景 |
| **连续性** | 可能中断 | 连续可靠 |

## 二、融合架构：松耦合 vs 紧耦合

根据传感器数据融合的深度，可分为**松耦合（Loosely-Coupled）**和**紧耦合（Tightly-Coupled）**两种架构。

<!-- 插入一行空格 -->
<div align=center>
<img src="../imgs/fusion_architecture.png" width="700" height="400">
</div>
<div align=center>图2. 松耦合与紧耦合架构对比</div>
<!-- 插入一行空格 -->

### 1. 松耦合（Loosely-Coupled）

#### 1.1 基本原理

松耦合架构中，各传感器首先独立解算位姿，然后将位姿结果在高层进行融合。

**典型流程**：
1. GNSS独立解算得到$\mathbf{x}_{\text{GNSS}}$
2. 视觉/激光SLAM独立解算得到$\mathbf{x}_{\text{VO/LO}}$
3. IMU积分得到$\mathbf{x}_{\text{IMU}}$
4. 使用卡尔曼滤波器融合多个位姿估计

#### 1.2 数学模型

状态向量通常包含位置、速度、姿态：

$$\mathbf{x} = [\mathbf{p}^T, \mathbf{v}^T, \mathbf{q}^T, \mathbf{b}_g^T, \mathbf{b}_a^T]^T$$

其中：
- $\mathbf{p} = [p_x, p_y, p_z]^T$：位置
- $\mathbf{v} = [v_x, v_y, v_z]^T$：速度
- $\mathbf{q} = [q_w, q_x, q_y, q_z]^T$：姿态四元数
- $\mathbf{b}_g$：陀螺仪零偏
- $\mathbf{b}_a$：加速度计零偏

**观测模型**：
各传感器输出作为独立的观测：

$$\mathbf{z}_{\text{GNSS}} = \mathbf{H}_{\text{GNSS}} \mathbf{x} + \mathbf{v}_{\text{GNSS}}$$
$$\mathbf{z}_{\text{VO}} = \mathbf{H}_{\text{VO}} \mathbf{x} + \mathbf{v}_{\text{VO}}$$

#### 1.3 优缺点

**优点**：
- 模块化程度高，各子系统独立
- 易于调试和维护
- 计算量相对较小
- 某一传感器失效不影响其他传感器工作

**缺点**：
- 信息损失：各传感器内部信息未充分利用
- 精度受限：融合精度受限于子系统输出精度
- 延时问题：各子系统处理延时可能不同

### 2. 紧耦合（Tightly-Coupled）

#### 2.1 基本原理

紧耦合架构中，各传感器的原始或底层特征数据直接融合，共同参与优化。

**典型形式**：
- **视觉-惯性紧耦合**：直接使用图像特征点和IMU预积分
- **激光-惯性紧耦合**：直接使用点云点和IMU测量
- **多传感器联合优化**：所有传感器原始数据共同优化位姿和地图

#### 2.2 视觉-惯性紧耦合示例

**IMU预积分（Pre-integration）**：

传统方法中，IMU积分需要已知初始位姿，每次优化后需要重新积分。IMU预积分将IMU测量相对于参考帧进行积分，避免重复计算。

预积分测量：

$$\Delta \mathbf{p}_{ij} = \sum_{k=i}^{j-1} \left[ \mathbf{v}_k \Delta t + \frac{1}{2} (\mathbf{R}_k (\tilde{\mathbf{a}}_k - \mathbf{b}_{a_k}) - \mathbf{g}) \Delta t^2 \right]$$

$$\Delta \mathbf{v}_{ij} = \sum_{k=i}^{j-1} \left[ \mathbf{R}_k (\tilde{\mathbf{a}}_k - \mathbf{b}_{a_k}) - \mathbf{g} \right] \Delta t$$

$$\Delta \mathbf{R}_{ij} = \prod_{k=i}^{j-1} \text{Exp}((\tilde{\boldsymbol{\omega}}_k - \mathbf{b}_{g_k}) \Delta t)$$

其中$\tilde{\mathbf{a}}$和$\tilde{\boldsymbol{\omega}}$为IMU测量，$\mathbf{R}$为旋转矩阵，$\text{Exp}(\cdot)$为指数映射。

**联合优化目标函数**：

$$\min_{\mathbf{X}} \left\{ \sum_{(i,j) \in \mathcal{I}} \|\mathbf{r}_{\mathcal{I}}(\hat{\mathbf{z}}_{b_{k+1}}^{b_k}, \mathbf{X})\|_{\mathbf{P}_{b_{k+1}}^{b_k}}^2 + \sum_{(i,j) \in \mathcal{C}} \|\mathbf{r}_{\mathcal{C}}(\hat{\mathbf{z}}_{l}^{c_j}, \mathbf{X})\|_{\mathbf{P}_{l}^{c_j}}^2 \right\}$$

其中：
- 第一项为IMU预积分残差
- 第二项为视觉重投影残差
- $\mathbf{P}$为协方差矩阵

#### 2.3 优缺点

**优点**：
- 信息利用充分，理论精度上限更高
- 可处理单目视觉的尺度问题（IMU提供尺度）
- 鲁棒性更强

**缺点**：
- 计算复杂度高
- 系统耦合度高，调试困难
- 对传感器同步要求高

### 3. 松耦合 vs 紧耦合对比

| 对比维度 | 松耦合 | 紧耦合 |
|----------|--------|--------|
| **融合层次** | 位姿级 | 原始测量/特征级 |
| **计算复杂度** | 较低 | 较高 |
| **理论精度** | 中等 | 更高 |
| **系统复杂度** | 模块化 | 高度耦合 |
| **调试难度** | 较易 | 较难 |
| **传感器同步要求** | 一般 | 严格 |
| **适用场景** | 量产车辆 | 研究/高性能需求 |

### 4. 混合架构

实际系统中常采用混合策略：
- 核心定位采用紧耦合（如VIO、LIO）
- 全局校正采用松耦合（如GPS位置约束）
- 地图匹配作为独立模块提供全局约束

## 三、卡尔曼滤波在定位中的应用

卡尔曼滤波（Kalman Filter, KF）及其扩展形式是多传感器融合定位的核心算法。

### 1. 线性卡尔曼滤波

对于线性系统：

**状态方程**：
$$\mathbf{x}_k = \mathbf{F}_k \mathbf{x}_{k-1} + \mathbf{B}_k \mathbf{u}_k + \mathbf{w}_k, \quad \mathbf{w}_k \sim \mathcal{N}(0, \mathbf{Q}_k)$$

**观测方程**：
$$\mathbf{z}_k = \mathbf{H}_k \mathbf{x}_k + \mathbf{v}_k, \quad \mathbf{v}_k \sim \mathcal{N}(0, \mathbf{R}_k)$$

**预测步骤**：
$$\hat{\mathbf{x}}_{k|k-1} = \mathbf{F}_k \hat{\mathbf{x}}_{k-1|k-1} + \mathbf{B}_k \mathbf{u}_k$$
$$\mathbf{P}_{k|k-1} = \mathbf{F}_k \mathbf{P}_{k-1|k-1} \mathbf{F}_k^T + \mathbf{Q}_k$$

**更新步骤**：
$$\mathbf{K}_k = \mathbf{P}_{k|k-1} \mathbf{H}_k^T (\mathbf{H}_k \mathbf{P}_{k|k-1} \mathbf{H}_k^T + \mathbf{R}_k)^{-1}$$
$$\hat{\mathbf{x}}_{k|k} = \hat{\mathbf{x}}_{k|k-1} + \mathbf{K}_k (\mathbf{z}_k - \mathbf{H}_k \hat{\mathbf{x}}_{k|k-1})$$
$$\mathbf{P}_{k|k} = (\mathbf{I} - \mathbf{K}_k \mathbf{H}_k) \mathbf{P}_{k|k-1}$$

其中$\mathbf{K}_k$为卡尔曼增益。

### 2. 扩展卡尔曼滤波（EKF）

自动驾驶系统通常是非线性的，需要使用EKF。

**非线性模型**：
$$\mathbf{x}_k = f(\mathbf{x}_{k-1}, \mathbf{u}_k) + \mathbf{w}_k$$
$$\mathbf{z}_k = h(\mathbf{x}_k) + \mathbf{v}_k$$

**线性化**：
通过一阶泰勒展开：
$$\mathbf{F}_k = \frac{\partial f}{\partial \mathbf{x}} \bigg|_{\hat{\mathbf{x}}_{k-1|k-1}, \mathbf{u}_k}$$
$$\mathbf{H}_k = \frac{\partial h}{\partial \mathbf{x}} \bigg|_{\hat{\mathbf{x}}_{k|k-1}}$$

然后使用标准KF公式进行更新。

### 3. 误差状态卡尔曼滤波（ESKF）

ESKF是自动驾驶定位中广泛使用的改进形式。

#### 3.1 核心思想

将状态分解为**名义状态（Nominal State）**和**误差状态（Error State）**：

$$\mathbf{x}_{\text{true}} = \mathbf{x}_{\text{nominal}} \oplus \delta \mathbf{x}$$

- 名义状态：非线性传播
- 误差状态：线性卡尔曼滤波估计

#### 3.2 优势

**（1）线性化点始终接近零点**
误差状态始终围绕零均值波动，线性化更精确。

**（2）避免万向节锁（Gimbal Lock）**
使用四元数表示姿态，避免欧拉角的奇异性。

**（3）降低计算复杂度**
误差状态维度通常小于名义状态。

#### 3.3 ESKF算法流程

**名义状态传播**（IMU积分）：
$$\hat{\mathbf{x}}_{k|k-1} = f(\hat{\mathbf{x}}_{k-1|k-1}, \mathbf{u}_k)$$

**误差状态卡尔曼滤波**：
- 误差状态预测：$\delta \hat{\mathbf{x}}_{k|k-1} = \mathbf{0}$
- 协方差预测：$\mathbf{P}_{k|k-1} = \mathbf{F}_{\delta} \mathbf{P}_{k-1|k-1} \mathbf{F}_{\delta}^T + \mathbf{Q}_k$
- 观测更新：标准KF更新公式

**状态修正**：
$$\hat{\mathbf{x}}_{k|k} = \hat{\mathbf{x}}_{k|k-1} \oplus \delta \hat{\mathbf{x}}_{k|k}$$

### 4. 多传感器融合中的观测模型

#### 4.1 GNSS观测

GNSS提供绝对位置观测：

$$\mathbf{z}_{\text{GNSS}} = \begin{bmatrix} x \\ y \\ z \end{bmatrix}, \quad \mathbf{H}_{\text{GNSS}} = \begin{bmatrix} \mathbf{I}_3 & \mathbf{0} \end{bmatrix}$$

若GNSS还提供速度（多普勒测速）：

$$\mathbf{z}_{\text{GNSS}} = \begin{bmatrix} x \\ y \\ z \\ v_x \\ v_y \\ v_z \end{bmatrix}, \quad \mathbf{H}_{\text{GNSS}} = \begin{bmatrix} \mathbf{I}_3 & \mathbf{0} \\ \mathbf{0} & \mathbf{I}_3 & \mathbf{0} \end{bmatrix}$$

#### 4.2 视觉里程计观测

视觉里程计提供相对位姿约束，通常观测速度或位姿变化：

$$\mathbf{z}_{\text{VO}} = \mathbf{v}_{\text{VO}} = \mathbf{v} + \mathbf{R}(\boldsymbol{\omega} \times \mathbf{t}_{\text{cam}}^{\text{IMU}}) + \mathbf{n}$$

其中$\mathbf{t}_{\text{cam}}^{\text{IMU}}$为IMU到相机的杆臂（lever arm）。

#### 4.3 地图匹配观测

高精地图匹配提供全局位置约束，通常作为位置观测：

$$\mathbf{z}_{\text{map}} = \mathbf{p} + \mathbf{n}_{\text{map}}$$

协方差$\mathbf{R}_{\text{map}}$反映匹配精度，通常在$0.01-0.1m$级别。

### 5. 协方差自适应

实际系统中需要动态调整观测噪声协方差：

**（1）GNSS质量评估**
- 根据HDOP（水平精度因子）调整$\mathbf{R}_{\text{GNSS}}$
- 多路径检测：增加城市峡谷中的$\mathbf{R}_{\text{GNSS}}$

**（2）视觉里程计质量评估**
- 跟踪特征点数量
- 重投影误差大小
- 动态物体比例

**（3）地图匹配质量评估**
- 匹配得分
- 点云配准残差
- 环境变化程度

协方差自适应公式：

$$\mathbf{R}_{\text{adaptive}} = \alpha \cdot \mathbf{R}_{\text{nominal}}$$

其中$\alpha$根据质量评估结果动态调整。

## 四、实际案例：自动驾驶融合定位系统

### 1. 系统架构示例

<!-- 插入一行空格 -->
<div align=center>
<img src="../imgs/fusion_system_arch.png" width="700" height="450">
</div>
<div align=center>图3. 多传感器融合定位系统架构</div>
<!-- 插入一行空格 -->

#### 1.1 传感器配置

| 传感器 | 型号/规格 | 输出频率 | 作用 |
|--------|-----------|----------|------|
| **GNSS** | 多频RTK接收机 | 10Hz | 绝对位置基准 |
| **IMU** | 战术级MEMS | 200Hz | 高频姿态、预测 |
| **LiDAR** | 128线 | 10Hz | 点云匹配定位 |
| **摄像头** | 前视+环视 | 30Hz | 视觉里程计、车道线检测 |
| **轮速计** | 车辆CAN | 100Hz | 车速、里程辅助 |

#### 1.2 软件模块

**（1）GNSS解算模块**
- RTK解算，输出厘米级位置
- 提供GNSS状态（固定/浮点/单点）

**（2）激光里程计模块**
- 点云配准（使用LIO-SAM或类似算法）
- 输出相对位姿和协方差

**（3）视觉里程计模块**
- 特征点跟踪
- 视觉惯性融合（可选）

**（4）地图匹配模块**
- 实时点云与高精地图匹配
- 输出全局位置校正

**（5）融合滤波器**
- ESKF融合所有观测
- 状态：位置、速度、姿态、IMU零偏

### 2. 典型场景分析

#### 2.1 开阔道路场景

**场景特征**：
- GNSS信号良好
- 道路特征丰富
- 高精地图覆盖完整

**融合策略**：
- GNSS作为绝对位置观测，协方差小
- 地图匹配提供厘米级约束
- IMU用于高频插值

**定位精度**：水平$<10cm$，垂直$<15cm$

#### 2.2 城市峡谷场景

**场景特征**：
- GNSS多路径严重
- 高楼遮挡导致信号断续
- 动态物体多

**融合策略**：
- GNSS协方差自适应增大
- 依赖激光/视觉里程计
- 地图匹配提供全局约束

**挑战**：
- 长时间GNSS缺失时，依赖里程计漂移
- 动态车辆干扰激光配准

#### 2.3 隧道场景

**场景特征**：
- GNSS完全丢失
- 照明条件差
- 结构单一（特征退化）

**融合策略**：
- 纯惯导+里程计模式
- 基于先验地图的匹配（若地图存在）
- 隧道入口/出口GNSS快速收敛

**精度退化**：
隧道内定位误差随时间增长：

$$\sigma(t) = \sigma_0 + \sigma_{\text{drift}} \cdot t$$

其中$\sigma_{\text{drift}}$为漂移率，通常在$0.1-0.5\%$里程。

### 3. 性能评估指标

#### 3.1 精度指标

**（1）RMSE（均方根误差）**

$$\text{RMSE} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} \|\mathbf{p}_i^{\text{est}} - \mathbf{p}_i^{\text{true}}\|^2}$$

**（2）CEP（圆概率误差）**
50%测量值落入的圆半径。

**（3）RMS误差分量**
分别统计纵向、横向、垂向误差。

#### 3.2 可用性指标

- **定位可用率**：定位服务可用时间占比
- **收敛时间**：从冷启动到固定解的时间
- **连续性**：定位不中断的持续时间

#### 3.3 完好性指标

- **完好性风险**：未检测到的定位故障概率
- **告警限值**：超过该阈值需告警
- **保护等级**：当前定位的不确定性边界

### 4. 业界实践案例

#### 4.1 百度Apollo定位方案

**技术路线**：
- MSF（Multi-Sensor Fusion）多传感器融合定位
- 融合GNSS、IMU、激光雷达、摄像头
- 基于EKF的紧耦合架构

**特点**：
- 支持多种GNSS模式（单点、DGPS、RTK）
- 基于GPU的实时点云处理
- 云端图优化增强

#### 4.2 Waymo定位方案

**技术路线**：
- 高度依赖高精地图
- 多激光雷达融合
- 深度学习辅助回环检测

**特点**：
- 厘米级定位精度
- 极端天气下的鲁棒性
- 城市级高精地图覆盖

#### 4.3 Tesla定位方案

**技术路线**：
- 以视觉为主的多传感器融合
- 强调"视觉优先"的感知定位一体化
- 众包地图更新

**特点**：
- 低依赖高精地图（相对传统方案）
- 大量使用神经网络
- 强调泛化能力

## 五、小结

本章详细介绍了多传感器融合定位的原理与实践：

1. **融合必要性**：单一传感器无法满足自动驾驶全场景需求
2. **融合架构**：松耦合 vs 紧耦合的权衡与选择
3. **核心算法**：卡尔曼滤波族（KF、EKF、ESKF）的理论与应用
4. **实际案例**：典型系统架构和场景分析

多传感器融合定位是自动驾驶系统的"指南针"，它通过智能组合各类传感器信息，为车辆提供连续、可靠、高精度的位置信息，是自动驾驶安全运行的基础保障。

---

## 参考文献

[1] Qin T, Li P, Shen S. Vins-mono: A robust and versatile monocular visual-inertial state estimator[J]. IEEE Transactions on Robotics, 2018, 34(4): 1004-1020.

[2] Shan T, Englot B, Meyers D, et al. LIO-SAM: Tightly-coupled lidar inertial odometry via smoothing and mapping[C]//2020 IEEE/RSJ International Conference on Intelligent Robots and Systems (IROS). IEEE, 2020: 5135-5142.

[3] Quan M, Piao S, Tan M, et al. Tightly-coupled monocular visual-odometric SLAM using wheels and a MEMS gyroscope[J]. IEEE Access, 2019, 7: 97374-97389.

[4] Zheng H, Liu Y, Lu X, et al. A tightly-coupled GPS/INS/ODO integration method based on an IMU-aided ambiguity function approach for land vehicle navigation[C]//2020 IEEE/ION Position, Location and Navigation Symposium (PLANS). IEEE, 2020: 990-996.

[5] 百度Apollo. Apollo自动驾驶定位技术详解[R]. 2021.

[6] Hsu L T. Analysis and modeling GPS NLOS effect in highly urbanized area[J]. GPS solutions, 2018, 22(1): 1-12.
